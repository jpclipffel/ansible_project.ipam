# code: language=Ansible insertSpaces=true tabSize=2

- name: Tests - Lookups
  hosts: nios
  collections:
    - infoblox.nios_modules
  connection: local
  tasks:

    - block:

      - name: Return the list of network views
        debug:
          msg: "{{ lookup('nios', 'networkview', provider=nios_provider) }}"

      - name: Return the list of views
        debug:
          msg: "{{ lookup('nios', 'view', provider=nios_provider) }}"

      - name: Return a single host record
        debug:
          msg: "{{ lookup('nios', 'record:host', filter={'name': 'k8s-ict-master-01.dt.ept.lu'}, provider=nios_provider) }}"

      - name: Return next IP
        debug:
          msg: "{{ lookup('nios_next_ip', '172.29.42.0/24', provider=nios_provider) }}"

      - name: Return the list of networks
        debug:
          msg: "{{ lookup('nios', 'network', filter={'network_view': 'DT-internal', 'network': '172.29.42.0/24'}, provider=nios_provider) }}"

      - name: Return the list of networks containers
        debug:
          msg: "{{ lookup('nios', 'networkcontainer', extattrs={'Plateforme': '49435400000001'}, provider=nios_provider) }}"

      tags: [never, lookup, lookups]


- name: Tests - Setup (create resources)
  hosts: nios
  connection: local
  tasks:

    - block:

      - name: Create a host record
        nios_host_record:
          name: created-by-ansible.dt.ept.lu
          view: DT-internal
          ipv4addrs:
            - ipv4addr: "{{ lookup('nios_next_ip', '172.29.42.0/24', provider=nios_provider)[0] }}"
          comment: "Host record created by Ansible test playbook"
          state: present
          provider: "{{ nios_provider }}"
        register: _create_host_record
        failed_when:
          - _create_host_record.failed and not "already exists" in _create_host_record.msg
  
      - name: Create a network
        nios_network:
          network: 172.27.253.128/25
          network_view: DT-internal
          extattrs:
            Plateforme: "49435400000003"
          comment: "Network created by Ansible test playbook"
          state: present
          provider: "{{ nios_provider }}"
        register: _create_network

      tags: [never, setup]


- name: Tests - Teardown & remove (delete resources)
  hosts: nios
  connection: local
  tasks:

    - block:

      - name: Delete a host record
        nios_host_record:
          name: created-by-ansible.dt.ept.lu
          view: "DT-internal"
          state: absent
          provider: "{{ nios_provider }}"
      
      - name: Delete a network
        nios_network:
          network: 172.27.253.128/25
          network_view: DT-internal
          state: absent
          provider: "{{ nios_provider }}"
      
      tags: [never, teardown, remove]
